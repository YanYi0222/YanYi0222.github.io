<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>練球費用分攤</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
      max-width: 600px;
      margin: auto;
    }
    label {
      display: block;
      margin-top: 1rem;
    }
    input, select, button {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.5rem;
      font-size: 1rem;
    }
    /* 修正背景與字體顏色 */
    input, select {
      color: #000; /* 深色字體 */
      font-size: 1rem;    
      background-color: #ffffff; /* 白色背景 */
      border: 1px solid #ccc; /* 淺灰色邊框 */
      box-sizing: border-box; /* 確保 padding 不影響寬度 */
    }
    input[type="number"] {
      text-align: center; /* 讓數字也居中顯示 */
    }
    table {
      width: 100%;
      margin-top: 2rem;
      border-collapse: collapse;
    }
    th, td {
      padding: 0.5rem;
      border-bottom: 1px solid #ccc;
      text-align: center;
    }
    .total {
      margin-top: 1rem;
      font-weight: bold;
    }
    .student-entry {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .student-entry input {
      flex: 1;
    }
  </style>
</head>
<body>
  <h1>練球費用分攤</h1>

  <label>日期
    <input type="date" id="date" />
  </label>

  <label>教練
    <select id="coach">
      <option value="A" data-rate="1000">教練A（$1000）</option>
      <option value="B" data-rate="1200">教練B（$1200）</option>
    </select>
  </label>

  <h3>學生練習時數</h3>
  <div id="students"></div>
  <button onclick="addStudent()">新增學生</button>

  <button onclick="calculate()">計算分攤金額</button>
  <button onclick="showSettlement()">顯示結算</button>

  <div class="total" id="result"></div>
  <div class="total" id="settlement"></div>

  <script>
    const studentsDiv = document.getElementById("students");
    let studentCount = 0;

    // 儲存已計算的紀錄
    function saveRecord(date, coachRate, students) {
      let records = JSON.parse(localStorage.getItem("records")) || [];
      records.push({ date, coachRate, students });
      localStorage.setItem("records", JSON.stringify(records));
    }

    // 新增學生欄位
    function addStudent(name = "", hours = "") {
      const div = document.createElement("div");
      div.className = "student-entry";
      div.innerHTML = `
        <input type="text" placeholder="學生姓名" value="${name}" />
        <input type="number" placeholder="時數" value="${hours}" min="0" step="0.1" />
        <button onclick="this.parentElement.remove()">刪除</button>
      `;
      studentsDiv.appendChild(div);
    }

    // 計算分攤金額
    function calculate() {
      const coachSel = document.getElementById("coach");
      const rate = +coachSel.options[coachSel.selectedIndex].dataset.rate;
      const date = document.getElementById("date").value;

      const entries = [...document.querySelectorAll(".student-entry")];
      const students = entries.map(e => {
        const name = e.querySelector("input[type=text]").value;
        const hrs = parseFloat(e.querySelector("input[type=number]").value);
        return { name, hrs };
      }).filter(s => s.name && s.hrs > 0);

      const totalHours = students.reduce((sum, s) => sum + s.hrs, 0);
      if (totalHours === 0) {
        alert("請輸入有效的學生與時數。");
        return;
      }

      let output = `<table><tr><th>學生</th><th>時數</th><th>應繳費用</th></tr>`;
      students.forEach(s => {
        const share = ((s.hrs / totalHours) * rate).toFixed(0);
        output += `<tr><td>${s.name}</td><td>${s.hrs}</td><td>$${share}</td></tr>`;
      });
      output += `</table><div class="total">總費用：$${rate}</div>`;

      document.getElementById("result").innerHTML = output;

      // 儲存紀錄
      saveRecord(date, rate, students);
    }

    // 顯示結算
    function showSettlement() {
      const records = JSON.parse(localStorage.getItem("records")) || [];
      const settlement = {};

      // 計算所有紀錄的總金額
      records.forEach(record => {
        record.students.forEach(student => {
          if (!settlement[student.name]) {
            settlement[student.name] = 0;
          }
          settlement[student.name] += (student.hrs / record.students.reduce((sum, s) => sum + s.hrs, 0)) * record.coachRate;
        });
      });

      let output = `<table><tr><th>學生</th><th>累積費用</th></tr>`;
      for (const [name, total] of Object.entries(settlement)) {
        output += `<tr><td>${name}</td><td>$${total.toFixed(0)}</td></tr>`;
      }
      output += `</table>`;

      document.getElementById("settlement").innerHTML = output;
    }

    // 預設新增兩位學生輸入欄位
    addStudent();
    addStudent();
  </script>
</body>
</html>
